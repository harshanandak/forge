# Lefthook Git Hooks Configuration
# TDD Enforcement for Forge Workflow
#
# To skip hooks in emergencies:
#   git commit --no-verify  (skip pre-commit)
#   LEFTHOOK=0 git push     (skip pre-push)

pre-commit:
  commands:
    tdd-check:
      run: node .forge/hooks/check-tdd.js
      stage_fixed: false
      tags: tdd
      glob: "*.{js,ts,jsx,tsx,py,go,java,rb}"

pre-push:
  commands:
    # 1. Block direct push to main/master (dual-layer protection)
    branch-protection:
      run: |
        branch=$(git branch --show-current)
        if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
          echo ""
          echo "üö´ Direct push to main/master blocked!"
          echo ""
          echo "Please use the feature branch workflow:"
          echo "  1. git checkout -b feat/your-feature"
          echo "  2. Make changes and commit"
          echo "  3. git push -u origin feat/your-feature"
          echo "  4. Create PR: gh pr create"
          echo ""
          echo "Emergency bypass: LEFTHOOK=0 git push"
          echo ""
          exit 1
        fi
      tags: protection

    # 2. ESLint check (strict: blocks on errors AND warnings)
    lint:
      run: |
        echo "üîç Running ESLint (strict mode)..."
        npx eslint .
        if [ $? -ne 0 ]; then
          echo ""
          echo "‚ùå ESLint errors/warnings found. Fix them before pushing."
          echo ""
          echo "To see errors: npx eslint ."
          echo "To auto-fix: npx eslint . --fix"
          echo ""
          echo "Emergency bypass: LEFTHOOK=0 git push"
          echo ""
          exit 1
        fi
        echo "‚úÖ ESLint check passed (no errors or warnings)"
      tags: lint

    # 3. Test suite (detect package manager: bun > pnpm > yarn > npm)
    tests:
      run: |
        echo "üß™ Running test suite..."
        if command -v bun >/dev/null 2>&1 && [ -f "bun.lockb" ]; then
          bun test
        elif command -v pnpm >/dev/null 2>&1 && [ -f "pnpm-lock.yaml" ]; then
          pnpm test
        elif command -v yarn >/dev/null 2>&1 && [ -f "yarn.lock" ]; then
          yarn test
        else
          npm test
        fi
        if [ $? -ne 0 ]; then
          echo ""
          echo "‚ùå Tests failed. Fix them before pushing."
          echo ""
          echo "Emergency bypass: LEFTHOOK=0 git push"
          echo ""
          exit 1
        fi
        echo "‚úÖ All tests passed"
      tags: tests
