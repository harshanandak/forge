# Lefthook Git Hooks Configuration
# TDD Enforcement for Forge Workflow
#
# To skip hooks in emergencies:
#   git commit --no-verify  (skip pre-commit)
#   LEFTHOOK=0 git push     (skip pre-push)

pre-commit:
  commands:
    tdd-check:
      run: node .forge/hooks/check-tdd.js
      stage_fixed: false
      tags: tdd
      glob: "*.{js,ts,jsx,tsx,py,go,java,rb}"

pre-push:
  commands:
    # 1. Block direct push to main/master (dual-layer protection)
    # Uses Node.js for cross-platform compatibility (Windows, macOS, Linux)
    branch-protection:
      run: node scripts/branch-protection.js
      tags: protection

    # 2. ESLint check (blocks on errors, warnings allowed)
    # To enable strict mode (errors + warnings): add --max-warnings 0
    # See Beads issue: forge-y8z for cleanup tracking
    lint:
      run: |
        echo "üîç Running ESLint..."
        bunx eslint .
        if [ $? -ne 0 ]; then
          echo ""
          echo "‚ùå ESLint errors found. Fix them before pushing."
          echo ""
          echo "To see errors: bunx eslint ."
          echo "To auto-fix: bunx eslint . --fix"
          echo ""
          echo "Emergency bypass: LEFTHOOK=0 git push"
          echo ""
          exit 1
        fi
        echo "‚úÖ ESLint check passed (no errors)"
      tags: lint

    # 3. Test suite (detect package manager: bun > pnpm > yarn > npm)
    tests:
      run: |
        echo "üß™ Running test suite..."
        if command -v bun >/dev/null 2>&1 && [ -f "bun.lockb" ]; then
          bun test
        elif command -v pnpm >/dev/null 2>&1 && [ -f "pnpm-lock.yaml" ]; then
          pnpm test
        elif command -v yarn >/dev/null 2>&1 && [ -f "yarn.lock" ]; then
          yarn test
        else
          npm test
        fi
        if [ $? -ne 0 ]; then
          echo ""
          echo "‚ùå Tests failed. Fix them before pushing."
          echo ""
          echo "Emergency bypass: LEFTHOOK=0 git push"
          echo ""
          exit 1
        fi
        echo "‚úÖ All tests passed"
      tags: tests
