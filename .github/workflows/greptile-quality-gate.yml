name: Greptile Quality Gate

on:
  pull_request_review:
    types: [submitted]

jobs:
  quality-gate:
    name: Greptile Quality Gate (‚â•4/5)
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'master'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check Greptile Score
        uses: actions/github-script@v7
        with:
          script: |
            // Only run for Greptile reviews (exact match)
            const reviewer = context.payload.review?.user?.login || '';
            console.log(`Review submitted by: ${reviewer}`);

            if (reviewer !== 'greptile-apps[bot]') {
              console.log('‚è≠Ô∏è Skipping: Not a Greptile review');
              return;
            }

            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const prBody = pr.body || '';
            console.log('Checking Greptile score in PR body...');

            // Extract score
            const scoreMatch = prBody.match(/Confidence Score:\s*(\d+(?:\.\d+)?)\s*(?:\/|out of)\s*5/i);

            if (!scoreMatch) {
              core.setFailed('‚ùå No Greptile confidence score found in PR description');
              return;
            }

            const score = parseFloat(scoreMatch[1]);
            const minScore = 4.0;

            console.log(`üìä Greptile Score: ${score}/5`);
            console.log(`üéØ Required: ${minScore}/5`);

            if (score < minScore) {
              core.setFailed(`‚ùå Greptile score ${score}/5 is below minimum ${minScore}/5`);
            } else {
              console.log(`‚úÖ PASSED: Score ${score}/5 meets threshold!`);
            }
