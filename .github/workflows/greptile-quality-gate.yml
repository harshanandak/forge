name: Greptile Quality Gate

on:
  check_run:
    types: [completed]

jobs:
  quality-gate:
    name: Greptile Quality Gate (‚â•4/5)
    runs-on: ubuntu-latest
    if: github.event.check_run.name == 'Greptile Review'
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Check Greptile Score
        uses: actions/github-script@v7
        with:
          script: |
            const checkRun = context.payload.check_run;
            const prs = checkRun.pull_requests;

            if (!prs || prs.length === 0) {
              console.log('‚è≠Ô∏è No PRs associated with this check run');
              return;
            }

            const pr = prs[0];

            // Only enforce on PRs targeting master
            if (pr.base.ref !== 'master') {
              console.log(`‚è≠Ô∏è Skipping: PR targets ${pr.base.ref}, not master`);
              return;
            }

            console.log(`üîç Checking Greptile score for PR #${pr.number}...`);

            // Get full PR details including body (Greptile updates body before marking check complete)
            const { data: prDetails } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const prBody = prDetails.body || '';

            // Extract confidence score
            const scoreMatch = prBody.match(/Confidence Score:\s*(\d+(?:\.\d+)?)\s*(?:\/|out of)\s*5/i);

            const headSha = checkRun.head_sha;
            const minScore = 4.0;
            let conclusion, title, summary;

            if (!scoreMatch) {
              conclusion = 'failure';
              title = '‚ùå No Greptile confidence score found in PR description';
              summary = 'Greptile may not have reviewed this PR yet, or the score format changed.';
            } else {
              const score = parseFloat(scoreMatch[1]);
              console.log(`üìä Greptile Score: ${score}/5`);
              console.log(`üéØ Required: ${minScore}/5`);

              if (score < minScore) {
                conclusion = 'failure';
                title = `‚ùå Greptile score ${score}/5 is below minimum ${minScore}/5`;
                summary = `Address Greptile review comments and push to re-trigger the review.`;
              } else {
                conclusion = 'success';
                title = `‚úÖ Greptile score ${score}/5 meets threshold`;
                summary = `Greptile confidence score ${score}/5 meets the required ${minScore}/5.`;
              }
            }

            // Create a check run on the PR's head commit so it appears in PR checks
            // (core.setFailed alone only fails the workflow run on master, not the PR check)
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Greptile Quality Gate (‚â•4/5)',
              head_sha: headSha,
              status: 'completed',
              conclusion: conclusion,
              output: { title, summary }
            });

            console.log(`‚úÖ Check run created on ${headSha} with conclusion: ${conclusion}`);

            if (conclusion === 'failure') {
              core.setFailed(title);
            }
